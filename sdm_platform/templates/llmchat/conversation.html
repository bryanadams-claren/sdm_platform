{% extends "base.html" %}

{% load static compress %}

{% block custom_css %}
  {% compress css %}
    <link href="{% static 'css/project.css' %}" rel="stylesheet" />
    <link href="{% static 'css/onboarding-tour.css' %}" rel="stylesheet" />
  {% endcompress %}
  <link href="{% static 'vendor/driverjs/driver.css' %}" rel="stylesheet" />
{% endblock custom_css %}
{% block body %}
  {% csrf_token %}
  <div id="pageConfig"
       data-is-viewing-as-admin="{{ conversation_owner|yesno:'true,false' }}"
       hidden></div>
  <div class="chat-layout">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="chat-list" id="chatList">
        {% for conv in conversations %}
          {% if conv.id|stringformat:"s" == active_conversation_id %}
            <div class="chat-item active" data-id="{{ conv.id }}">{{ conv.title|default:"Untitled Conversation" }}</div>
          {% else %}
            <div class="chat-item" data-id="{{ conv.id }}">{{ conv.title|default:"Untitled Conversation" }}</div>
          {% endif %}
        {% endfor %}
      </div>
      {% if conversation_owner %}
        <a href="{% url 'users:detail' conversation_owner.pk %}"
           class="user-info d-flex align-items-center text-decoration-none color-inherit">
          {% if conversation_owner.avatar %}
            <img src="{{ conversation_owner.avatar.url }}"
                 class="rounded-circle me-2 avatar-small"
                 alt="{{ conversation_owner.name }}" />
          {% else %}
            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-2 avatar-initial">
              {{ conversation_owner.name|first|upper|default:"?" }}
            </div>
          {% endif %}
          <div>
            <strong>{{ conversation_owner.name }}</strong>
            <br />
            <small><i class="bi bi-person-circle"></i> Profile</small>
          </div>
        </a>
      {% else %}
        <a href="{% url 'users:detail' request.user.pk %}"
           id="userProfileLink"
           class="user-info d-flex align-items-center text-decoration-none color-inherit">
          {% if request.user.avatar %}
            <img src="{{ request.user.avatar.url }}"
                 class="rounded-circle me-2 avatar-small"
                 alt="{{ request.user.name }}" />
          {% else %}
            <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-2 avatar-initial">
              {{ request.user.name|first|upper|default:"?" }}
            </div>
          {% endif %}
          <div>
            <strong>{{ request.user.name }}</strong>
            <br />
            <small><i class="bi bi-person-circle"></i> Profile</small>
          </div>
        </a>
      {% endif %}
    </div>
    <!-- Chat Panel -->
    <div class="chat-panel">
      <div id="chatMessages" class="chat-messages">
        <div class="message bot">
          <div class="msg-text">ðŸ‘‹ Loadingâ€¦</div>
        </div>
      </div>
      <div class="chat-input">
        <div id="suggestionBubbles" class="suggestion-bubbles"></div>
        <div class="input-group">
          {% if conversation_owner %}
            <input id="chatInput"
                   type="text"
                   class="form-control"
                   placeholder="Input only available to patient"
                   disabled />
            <button id="sendBtn" class="btn btn-primary" disabled>Send</button>
          {% else %}
            <input id="chatInput"
                   type="text"
                   class="form-control"
                   placeholder="Type a message..." />
            <button id="sendBtn" class="btn btn-primary">Send</button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  <!-- SDM Info Modal -->
  <div class="modal fade"
       id="sdmInfoModal"
       tabindex="-1"
       aria-labelledby="sdmInfoModalLabel"
       aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="sdmInfoModalLabel">About Shared Decision Making</h5>
          <button type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <h6>What is Shared Decision Making?</h6>
          <p>
            Shared decision making is a collaborative process where you and your healthcare team work together to make decisions about your care. Your values, preferences, and goals matter just as much as the medical evidence.
          </p>
          <h6>How This Works</h6>
          <p>
            This conversation will guide you through several important topics to help you understand your options and make a decision that's right for you. The topics on the left track our progress through this process.
          </p>
          <h6>Your Summary</h6>
          <p>
            Once we've discussed all the topics, a personalized PDF summary will be available for you to download and share with your healthcare provider.
          </p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Got it</button>
        </div>
      </div>
    </div>
  </div>
{% endblock body %}
{% block user_javascript %}
  <script src="{% static 'vendor/marked/marked.min.js' %}"></script>
  <script src="{% static 'vendor/driverjs/driver.js.iife.js' %}"></script>
  {% compress js %}
    <script defer src="{% static 'js/websocket-base.js' %}"></script>
    <script defer src="{% static 'js/chat-websocket.js' %}"></script>
    <script defer src="{% static 'js/status-websocket.js' %}"></script>
    <script defer src="{% static 'js/conversationpoints.js' %}"></script>
    <script defer src="{% static 'js/chat.js' %}"></script>
  {% endcompress %}
  <script src="{% static 'js/onboarding-tour.js' %}"></script>
{% endblock user_javascript %}
