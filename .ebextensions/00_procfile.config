# .ebextensions/00_procfile.config
# Dynamically generate Procfile based on environment name

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/01_generate_procfile.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash

      # Get the environment name
      ENV_NAME=$(/opt/elasticbeanstalk/bin/get-config environment -k EnvironmentName 2>/dev/null || echo "unknown")

      # Determine which Procfile to use based on environment name
      if [[ "$ENV_NAME" == *"worker"* ]]; then
        echo "Generating Procfile for worker environment"
        cat > /var/app/staging/Procfile << 'EOF'
      worker: celery -A config.celery_app worker --loglevel=info --concurrency=2
      beat: celery -A config.celery_app beat --loglevel=info
      EOF
      else
        echo "Generating Procfile for web environment"
        cat > /var/app/staging/Procfile << 'EOF'
      web: gunicorn config.asgi:application -k uvicorn_worker.UvicornWorker --bind :8000 --workers 2 --timeout 120 --log-level debug --access-logfile - --error-logfile - --capture-output --enable-stdio-inheritance
      EOF
      fi

      echo "Generated Procfile:"
      cat /var/app/staging/Procfile

container_commands:
  01_generate_procfile:
    command: "/opt/elasticbeanstalk/hooks/appdeploy/pre/01_generate_procfile.sh"
