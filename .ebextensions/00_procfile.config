# .ebextensions/00_procfile.config
# Dynamically generate Procfile based on environment name

container_commands:
  01_generate_procfile:
    command: |
      #!/bin/bash

      # Ensure the staging directory exists
      mkdir -p /var/app/staging

      # Get the environment name
      ENV_NAME=$(/opt/elasticbeanstalk/bin/get-config environment -k EnvironmentName 2>/dev/null || echo "unknown")

      echo "=== PROCFILE GENERATION DEBUG ==="
      echo "Environment Name: '$ENV_NAME'"
      echo "Checking if '$ENV_NAME' contains 'worker'"

      # Determine which Procfile to use based on environment name
      if [[ "$ENV_NAME" == *"worker"* ]]; then
        echo "Match found! Generating Procfile for WORKER environment"
        cat > /var/app/staging/Procfile << 'EOF'
worker: celery -A config.celery_app worker --loglevel=info --concurrency=2
beat: celery -A config.celery_app beat --loglevel=info
EOF
      else
        echo "No match. Generating Procfile for WEB environment"
        cat > /var/app/staging/Procfile << 'EOF'
web: gunicorn config.asgi:application -k uvicorn_worker.UvicornWorker --bind :8000 --workers 2 --timeout 120 --log-level debug --access-logfile - --error-logfile - --capture-output --enable-stdio-inheritance
EOF
      fi

      echo "=== Generated Procfile contents ==="
      cat /var/app/staging/Procfile
      echo "==================================="
